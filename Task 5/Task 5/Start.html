<!DOCTYPE html>
<html>
<head>

    <style>
        body {
            padding: 3%;
        }

        .no-js #loader {
            display: none;
        }

        .js #loader {
            display: block;
            position: absolute;
            left: 100px;
            top: 0;
        }

        .se-pre-con {
            position: fixed;
            left: 0px;
            top: 0px;
            width: 100%;
            height: 100%;
            z-index: 9999;
            background: url(https://www.w3schools.com/images/picture.jpg) center no-repeat #fff;
        }
    </style>

    <title></title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1.24.min.js"></script> <!-- Must be used to gain access to AWS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script><!-- loading wheel thing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.js"></script>
    <script type='text/javascript'>
        $(window).load(function () {
            // Animate loader off screen
            $(".se-pre-con").fadeOut("slow");;
        });
    </script>

    <script>

        //Should implement the same security done in Task 4 for the http https

        //These data are from AWS account details

        //might need update before starting
        AWS.config.update({
            accessKeyId: 'ASIAXPRNTRDKC45KDDXX',
            secretAccessKey: '2FWG5OpITndicuRN8eYapEu+Y7LBmJUeCKpmFsk3',
            sessionToken: 'FwoGZXIvYXdzEHMaDIY1+AFbcUrk/2SIvCLKAYikERUSNYMy4Srhi6jQC+NqQws2gyLlVJEj+RqT53vhqS52gPkaGUKGx+yM8oJD2SmDeTAVBa6uvfiprggjR+897EmnTMpdiwfV1A2jL8e/Hfv8EtP/L2ws1XbKFg55oKxm56Tg6v1erC/s9sTYB7/SG/b0nc5MHPU4+YYEobOWLL/oagTP+AaPUzC6RViv9yBmDt38aG4B65eJMkoAoHE5K/pSfLylLHpZKmfvZup4z3jHL5kvxMDn2SgO0i1Ho5jDt1sUzJfituUo2oHW/wUyLdPXh/OhIyy67WVYu3o7HdRm6vu+YNW3XzcNL+isGG2Rs/MFabPvrLkQZdqzSA=='
        });

        AWS.config.region = 'us-east-1'; //region for where the server will be in
        function uploadFile() { //Start of Upload method to S3
            var s3 = new AWS.S3({
                params: { Bucket: 'royston-bukit' } //Name of S3 bucket used
            });
            var file = document.getElementById('file').files[0]; //get the file
            console.log(file)
            if (file) {
                s3.putObject({
                    Key: file.name,
                    ContentType: file.type,
                    Body: file,
                    ACL: "public-read"
                },
                    function (err, data) {
                        if (data !== null) {
                            alert("Upload succesful!"); //upload success
                        }
                        else {
                            alert("Upload failed!"); //upload failed
                        }
                    });
            }
        }

    </script>

    <script type="text/javascript">
        var BucketName = 'royston-bukit'; //Name of S3 bucket used

        function listObjs() { //Start of listing method
            var s3 = new AWS.S3({
                params: { Bucket: BucketName }
            });
            s3.listObjects(function (error, data) {
                if (error === null) {
                    var html_urls = 'Short URLs (using bit.ly):<br />';
                    var html_images = '';
                    var longurl = "";
                    var params = {
                        "long_url": longurl
                    };
                    var accessToken = "a84626d62fd2d791069b91554490b2f58911c492"; //access token generated by bit.ly (cancer for password)
                    jQuery.each(data.Contents, function (index, obj) {
                        longurl = "https://s3.amazonaws.com/" + BucketName + "/" + obj.Key;
                        params = {
                            "long_url": longurl
                        };
                        $.ajax({
                            url: "https://api-ssl.bitly.com/v4/shorten",
                            cache: false,
                            dataType: "json",
                            method: "POST",
                            contentType: "application/json",
                            beforeSend: function (xhr) {
                                xhr.setRequestHeader("Authorization", "Bearer " + accessToken);
                            },
                            data: JSON.stringify(params)
                        }).done(function (data) {
                            html_urls += (index + 1 + ': ' + obj.Key + ' Link = ' + JSON.parse(JSON.stringify(data)).link + '<br /> <br />');
                            console.log(html_urls);
                            jQuery("#objectUrl").html(html_urls);
                        }).fail(function (data) {
                            console.log(data);
                        });
                        html_images += "<img src='" + "https://s3.amazonaws.com/" + BucketName + "/" + obj.Key + "'/><br/><br/>";
                    });

                    console.log('Loaded all items' + html_urls)
                    jQuery("#objectImages").html(html_images);

                } else { console.log(error); }
            });
            //End of listing method
        }</script>
</head>
<body>
    <div class="se-pre-con"></div>

    <input type="file" name="file" id="file" value="dataFile" required="">

    <button onclick="uploadFile()">Upload</button>
    <button onclick="listObjs()">View</button> <!-- Can change to bootstrap CSS not done -->

    <div id="objectUrl"></div>
    <div id="objectImages"></div>
</body>
</html>

